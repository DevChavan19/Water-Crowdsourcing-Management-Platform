package com.watercrowdsourcing.image_service.service;

import java.time.LocalDateTime;
import java.util.List;

import org.modelmapper.ModelMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.watercrowdsourcing.image_service.custom_exceptions.ResourceNotFoundException;
import com.watercrowdsourcing.image_service.dtos.ApiResponse;
import com.watercrowdsourcing.image_service.dtos.AssignDepartmentRequest;
import com.watercrowdsourcing.image_service.dtos.CreateReportRequest;
import com.watercrowdsourcing.image_service.dtos.ReportResponse;
import com.watercrowdsourcing.image_service.dtos.UpdateReportStatusRequest;
import com.watercrowdsourcing.image_service.dtos.VerifyReportRequest;
import com.watercrowdsourcing.image_service.entities.Image;
import com.watercrowdsourcing.image_service.entities.ReportStatus;
import com.watercrowdsourcing.image_service.repository.ImageRepository;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Service
@Transactional
@RequiredArgsConstructor
@Slf4j
public class ReportServiceImpl implements ReportService {

    private final ImageRepository reportRepository;
    private final ModelMapper modelMapper;

    // ================= USER =================

    @Override
    public ReportResponse createReport(Long userId, CreateReportRequest request) {

        Image report = new Image();
        report.setUserId(userId);
        report.setDescription(request.getDescription());
        report.setLatitude(request.getLatitude());
        report.setLongitude(request.getLongitude());
        report.setImageIds(request.getImageIds());

        report.setStatus(ReportStatus.SUBMITTED);
        report.setCreatedAt(LocalDateTime.now());

        Image saved = reportRepository.save(report);
        return modelMapper.map(saved, ReportResponse.class);
    }


    @Override
    public List<ReportResponse> getReportsByUser(Long userId) {
        return reportRepository.findByUserId(userId)
                .stream()
                .map(r -> modelMapper.map(r, ReportResponse.class))
                .toList();
    }

    @Override
    public ReportResponse getReportById(Long reportId) {
        Image report = reportRepository.findById(reportId)
                .orElseThrow(() ->
                        new ResourceNotFoundException("Report not found"));

        return modelMapper.map(report, ReportResponse.class);
    }

    // ================= ADMIN =================

    @Override
    public List<ReportResponse> getReportsByStatus(ReportStatus status) {
        return reportRepository.findByStatus(status)
                .stream()
                .map(r -> modelMapper.map(r, ReportResponse.class))
                .toList();
    }

    @Override
    public ApiResponse verifyReport(Long reportId, VerifyReportRequest request) {

        Image report = getReportEntity(reportId);

        if (report.getStatus() != ReportStatus.SUBMITTED) {
            throw new IllegalStateException("Only SUBMITTED reports can be verified");
        }

        report.setStatus(ReportStatus.VERIFIED);
        return new ApiResponse("SUCCESS", "Report verified");
    }

    @Override
    public ApiResponse assignDepartment(Long reportId, AssignDepartmentRequest request) {

        Image report = getReportEntity(reportId);

        if (report.getStatus() != ReportStatus.VERIFIED) {
            throw new IllegalStateException("Verify report before assigning");
        }

        report.setDepartmentId(request.getDepartmentId());
        report.setIssueId(request.getIssueId());
        report.setStatus(ReportStatus.ASSIGNED);

        return new ApiResponse("SUCCESS", "Department assigned");
    }

    // ================= DEPARTMENT =================

    @Override
    public ApiResponse updateReportStatus(Long reportId, UpdateReportStatusRequest request) {

        Image report = getReportEntity(reportId);

        report.setStatus(request.getStatus());
        return new ApiResponse("SUCCESS", "Report status updated");
    }

    // ================= INTERNAL =================

    private Image getReportEntity(Long reportId) {
        return reportRepository.findById(reportId)
                .orElseThrow(() ->
                        new ResourceNotFoundException("Report not found"));
    }



}


//@Service
//@Transactional
//@RequiredArgsConstructor
//public class ReportServiceImpl implements ReportService {
//
//    private final ReportRepository reportRepository;
//
//    // USER
//    @Override
//    public Report createReport(Long userId, CreateReportRequest request) {
//        Report report = new Report();
//        report.setTitle(request.getTitle());
//        report.setDescription(request.getDescription());
//        report.setLatitude(request.getLatitude());
//        report.setLongitude(request.getLongitude());
//        report.setUserId(userId);
//        report.setStatus(ReportStatus.PENDING_VERIFICATION);
//
//        return reportRepository.save(report);
//    }
//
//    @Override
//    public List<Report> getReportsByUser(Long userId) {
//        return reportRepository.findByUserId(userId);
//    }
//
//    // ADMIN
//    @Override
//    public List<Report> getReportsByStatus(ReportStatus status) {
//        return reportRepository.findByStatus(status);
//    }
//
//    @Override
//    public ApiResponse verifyReport(Long reportId) {
//        Report report = reportRepository.findById(reportId)
//                .orElseThrow(() -> new ResourceNotFoundException("Report not found"));
//
//        report.setStatus(ReportStatus.VERIFIED);
//        return new ApiResponse("SUCCESS", "Report verified");
//    }
//
//    @Override
//    public ApiResponse assignDepartmentAndIssue(
//            Long reportId,
//            Long departmentId,
//            Long issueId) {
//
//        Report report = reportRepository.findById(reportId)
//                .orElseThrow(() -> new ResourceNotFoundException("Report not found"));
//
//        report.setDepartmentId(departmentId);
//        report.setIssueId(issueId);
//        report.setStatus(ReportStatus.ASSIGNED);
//
//        return new ApiResponse("SUCCESS", "Report assigned to department");
//    }
//
//    // DEPARTMENT
//    @Override
//    public List<Report> getReportsByDepartment(Long departmentId) {
//        return reportRepository.findByDepartmentId(departmentId);
//    }
//
//    @Override
//    public ApiResponse updateReportStatus(Long reportId, ReportStatus status) {
//        Report report = reportRepository.findById(reportId)
//                .orElseThrow(() -> new ResourceNotFoundException("Report not found"));
//
//        report.setStatus(status);
//        return new ApiResponse("SUCCESS", "Report status updated");
//    }
//}
