package com.watercrowdsourcing.report_service.controller;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PatchMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.watercrowdsourcing.report_service.dtos.ReportRequest;
import com.watercrowdsourcing.report_service.entities.ReportStatus;
import com.watercrowdsourcing.report_service.service.ReportService;

import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@RestController
@RequestMapping("/reports")
@RequiredArgsConstructor
@Slf4j
public class ReportController {

    private final ReportService reportService;

    // ================= USER =================

    @PostMapping
    public ResponseEntity<?> createReport(
            @RequestHeader("X-User-Id") Long userId,
            @RequestBody @Valid ReportRequest request) {

        return ResponseEntity
                .status(HttpStatus.CREATED)
                .body(reportService.createReport(userId, request));
    }

    @GetMapping("/user/{userId}")
    public ResponseEntity<?> getReportsByUser(@PathVariable Long userId) {
        return ResponseEntity.ok(reportService.getReportsByUser(userId));
    }

    // ================= ADMIN =================

    @GetMapping("/status/{status}")
    public ResponseEntity<?> getReportsByStatus(@PathVariable ReportStatus status) {
        return ResponseEntity.ok(reportService.getReportsByStatus(status));
    }

    @PatchMapping("/{reportId}/verify")
    public ResponseEntity<?> verifyReport(@PathVariable Long reportId) {
        return ResponseEntity.ok(reportService.verifyReport(reportId));
    }

    @PatchMapping("/{reportId}/assign")
    public ResponseEntity<?> assignDepartmentAndIssue(
            @PathVariable Long reportId,
            @RequestParam Long departmentId,
            @RequestParam Long issueId) {

        return ResponseEntity.ok(
                reportService.assignDepartmentAndIssue(
                        reportId,
                        departmentId,
                        issueId
                )
        );
    }

    // ================= DEPARTMENT =================

    @GetMapping("/department/{departmentId}")
    public ResponseEntity<?> getReportsByDepartment(
            @PathVariable Long departmentId) {

        return ResponseEntity.ok(
                reportService.getReportsByDepartment(departmentId));
    }

    @PatchMapping("/{reportId}/status")
    public ResponseEntity<?> updateReportStatus(
            @PathVariable Long reportId,
            @RequestParam ReportStatus status) {

        return ResponseEntity.ok(
                reportService.updateReportStatus(reportId, status));
    }
}
